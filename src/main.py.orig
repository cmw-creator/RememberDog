<<<<<<< HEAD
from vision.camera_manager  import  CameraManager
from vision.qr_code_detector  import  QRCodeDetector
from vision.face_detector  import  FaceDetector
from vision.photo_detector  import  PhotoDetector
#from vision.hand_pose_estimator import HandPoseEstimator
from speech.voice_assistant import VoiceAssistant
from memory.memory_manager import MemoryManager 
from speech.speech_engine import SpeechEngine
from control.control import RobotController
import threading
import time

from memory.qa_manager import QAManager

#ç®¡ç†æœºå™¨ç‹—åŠ¨ä½œ
robot_controller=RobotController()

# åˆ›å»ºæ‘„åƒå¤´ç®¡ç†å™¨
# cam_manager = CameraManager("rtsp://192.168.1.120:8554/test") #ç‹—ä¸Šä½¿ç”¨
    
cam_manager = CameraManager(0) #åœ¨è‡ªå·±ç¬”è®°æœ¬ä¸Šæµ‹è¯•


def main():
    # åˆ›å»ºè®°å¿†ç®¡ç†å™¨
    memory_manager = MemoryManager()
    #åˆ›å»ºè¯­éŸ³å¼•æ“
    speech_engine = SpeechEngine(memory_manager)
    cam_manager.start()
    # åˆ›å»ºæ£€æµ‹å™¨
    qr_detector = QRCodeDetector(cam_manager,memory_manager)
    face_detector=FaceDetector(cam_manager,memory_manager)
    photo_detector=PhotoDetector(cam_manager,memory_manager)
    # åˆ›å»ºæ‰‹éƒ¨å§¿æ€æ£€æµ‹å™¨
    '''
    hand_estimator = HandPoseEstimator(
        cam_manager,
        memory_manager,
        model_path="./assets/handpose_x/weights/squeezenet1_1-size-256-loss-0.0732.pth",   #è½»é‡æ¨¡å‹
        model='squeezenet1_1',
        num_classes=42,
        GPUS='0',
        img_size=(256, 256)
    )
    '''
    voice_assistant = VoiceAssistant(memory_manager,robot_controller)
    
=======
# main.py - ä¿®å¤ç‰ˆæœ¬
import threading
import time
import traceback
import sys
import os

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.insert(0, current_dir)


def main():
    global memory_manager
    print("æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...")
    print(f"å·¥ä½œç›®å½•: {os.getcwd()}")
    print(f"Pythonè·¯å¾„: {sys.path}")

    try:
        # ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–è®°å¿†ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
        # æ ¹æ®å®é™…ç»“æ„è°ƒæ•´å¯¼å…¥è·¯å¾„
        try:
            from memory.memory_manager import MemoryManager
        except ImportError:
            # å¦‚æœåœ¨srcç›®å½•ä¸­
            from src.memory.memory_manager import MemoryManager

        memory_manager = MemoryManager()
        print("âœ“ è®°å¿†ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
>>>>>>> origin/hty

        # ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–è¯­éŸ³æœåŠ¡ï¼ˆåŸºç¡€æœåŠ¡ï¼‰
        try:
            from speech.speech_service import speech_service
        except ImportError:
            from src.speech.speech_service import speech_service
        print("âœ“ è¯­éŸ³æœåŠ¡åˆå§‹åŒ–å®Œæˆ")

        # ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–è¯­éŸ³å¼•æ“
        try:
            from speech.speech_engine import SpeechEngine
        except ImportError:
            from src.speech.speech_engine import SpeechEngine
        speech_engine = SpeechEngine(memory_manager)
        print("âœ“ è¯­éŸ³å¼•æ“åˆå§‹åŒ–å®Œæˆ")

        # ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–æ‘„åƒå¤´ç®¡ç†å™¨
        try:
            from vision.camera_manager import CameraManager
        except ImportError:
            from src.vision.camera_manager import CameraManager
        cam_manager = CameraManager()
        cam_manager.start()
        print("âœ“ æ‘„åƒå¤´ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")

        # ç¬¬äº”æ­¥ï¼šåˆå§‹åŒ–å„ä¸ªæ£€æµ‹å™¨
        try:
            from vision.qr_code_detector import QRCodeDetector
            from vision.face_detector import FaceDetector
            from vision.photo_detector import PhotoDetector
        except ImportError:
            from src.vision.qr_code_detector import QRCodeDetector
            from src.vision.face_detector import FaceDetector
            from src.vision.photo_detector import PhotoDetector

        qr_detector = QRCodeDetector(cam_manager, memory_manager)
        face_detector = FaceDetector(cam_manager, memory_manager)
        photo_detector = PhotoDetector(cam_manager, memory_manager)
        print("âœ“ è§†è§‰æ£€æµ‹å™¨åˆå§‹åŒ–å®Œæˆ")

        # ç¬¬å…­æ­¥ï¼šåˆå§‹åŒ–å™ªå£°æ£€æµ‹å™¨
        print("ğŸ”„ åˆå§‹åŒ–å™ªå£°æ£€æµ‹å™¨...")
        try:
            from voice.enhanced_noise_detector_fixed import EnhancedNoiseDetectorYamnet
            noise_detector = EnhancedNoiseDetectorYamnet(memory_manager, sensitivity=0.1)

            # ä¿®å¤ï¼šç›´æ¥æ£€æŸ¥modelå±æ€§æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºNone
            if hasattr(noise_detector, 'model') and noise_detector.model is not None:
                print("âœ“ YAMNetå™ªå£°æ£€æµ‹å™¨åˆå§‹åŒ–å®Œæˆ - æ™ºèƒ½åˆ†ç±»æ¨¡å¼")
            else:
                print("âš ï¸ YAMNetæ¨¡å‹æœªåŠ è½½ï¼Œä½¿ç”¨ç®€åŒ–æ£€æµ‹")
                # å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œåˆ‡æ¢åˆ°å¤‡ç”¨æ£€æµ‹å™¨
                # from voice.fallback_noise_detector import FallbackNoiseDetector
                # noise_detector = FallbackNoiseDetector(memory_manager)

        except ImportError as e:
            print(f"å¯¼å…¥é”™è¯¯: {e}")
            try:
                from src.voice.enhanced_noise_detector_fixed import EnhancedNoiseDetectorYamnet
                noise_detector = EnhancedNoiseDetectorYamnet(memory_manager, sensitivity=0.3)

                if hasattr(noise_detector, 'model') and noise_detector.model is not None:
                    print("âœ“ YAMNetå™ªå£°æ£€æµ‹å™¨åˆå§‹åŒ–å®Œæˆ - æ™ºèƒ½åˆ†ç±»æ¨¡å¼")
                else:
                    print("âš ï¸ YAMNetæ¨¡å‹æœªåŠ è½½ï¼Œä½¿ç”¨ç®€åŒ–æ£€æµ‹")

            except Exception as e:
                print(f"âœ— å™ªå£°æ£€æµ‹å™¨åˆå§‹åŒ–å¤±è´¥: {e}")
                # ä½¿ç”¨å¤‡ç”¨æ£€æµ‹å™¨
                try:
                    from src.voice.fallback_noise_detector import FallbackNoiseDetector
                    noise_detector = FallbackNoiseDetector(memory_manager)
                    print("âœ“ å¤‡ç”¨å™ªå£°æ£€æµ‹å™¨åˆå§‹åŒ–å®Œæˆ")
                except:
                    print("âŒ æ‰€æœ‰å™ªå£°æ£€æµ‹å™¨éƒ½åˆå§‹åŒ–å¤±è´¥")
                    noise_detector = None
        except Exception as e:
            print(f"âœ— å™ªå£°æ£€æµ‹å™¨åˆå§‹åŒ–å¤±è´¥: {e}")
            # ä½¿ç”¨å¤‡ç”¨æ£€æµ‹å™¨
            try:
                from src.voice.fallback_noise_detector import FallbackNoiseDetector
                noise_detector = FallbackNoiseDetector(memory_manager)
                print("âœ“ å¤‡ç”¨å™ªå£°æ£€æµ‹å™¨åˆå§‹åŒ–å®Œæˆ")
            except:
                print("âŒ æ‰€æœ‰å™ªå£°æ£€æµ‹å™¨éƒ½åˆå§‹åŒ–å¤±è´¥")
                noise_detector = None
        # ç¬¬ä¸ƒæ­¥ï¼šåˆå§‹åŒ–è¯­éŸ³åŠ©æ‰‹
        try:
            from speech.voice_assistant import VoiceAssistant
        except ImportError:
            from src.speech.voice_assistant import VoiceAssistant
        voice_assistant = VoiceAssistant(memory_manager)
        print("âœ“ è¯­éŸ³åŠ©æ‰‹åˆå§‹åŒ–å®Œæˆ")

        # æ³¨å†Œæ¨¡å—çŠ¶æ€
        modules = {
            "QRCodeDetector": qr_detector,
            "FaceDetector": face_detector,
            "PhotoDetector": photo_detector,
            "VoiceAssistant": voice_assistant,
            "NoiseDetector": noise_detector,
            "MemoryManager": memory_manager,
            "SpeechEngine": speech_engine
        }

        for name, module in modules.items():
            memory_manager.update_module_status(name, "initialized")

        # æŒ‰é¡ºåºå¯åŠ¨çº¿ç¨‹
        print("æ­£åœ¨å¯åŠ¨å„ä¸ªæ¨¡å—...")

        # 1. å¯åŠ¨è®°å¿†ç®¡ç†å™¨
        memory_manager.start()

        # 2. å¯åŠ¨å™ªå£°æ£€æµ‹å™¨
        if hasattr(noise_detector, 'start'):
            noise_thread = threading.Thread(target=noise_detector.start, name="NoiseDetector")
            noise_thread.daemon = True
            noise_thread.start()
            print("âœ“ å™ªå£°æ£€æµ‹å™¨å¯åŠ¨å®Œæˆ")

        # 3. å¯åŠ¨è§†è§‰æ£€æµ‹å™¨
        qr_thread = threading.Thread(target=qr_detector.run_detection, name="QRDetector")
        face_thread = threading.Thread(target=face_detector.run_detection, name="FaceDetector")
        photo_thread = threading.Thread(target=photo_detector.run_detection, name="PhotoDetector")

        qr_thread.daemon = True
        face_thread.daemon = True
        photo_thread.daemon = True

        qr_thread.start()
        time.sleep(0.5)

        face_thread.start()
        time.sleep(0.5)

        photo_thread.start()
        print("âœ“ è§†è§‰æ£€æµ‹å™¨å¯åŠ¨å®Œæˆ")

        # 4. å¯åŠ¨è¯­éŸ³åŠ©æ‰‹
        voice_assistant.start()
        print("âœ“ è¯­éŸ³åŠ©æ‰‹å¯åŠ¨å®Œæˆ")

        # æ›´æ–°çŠ¶æ€ä¸ºè¿è¡Œä¸­
        for name in modules.keys():
            memory_manager.update_module_status(name, "running")

        print("ğŸ‰ æ‰€æœ‰æ¨¡å—å¯åŠ¨å®Œæˆï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡Œä¸­...")
        print("ğŸ”Š å™ªå£°æ£€æµ‹åŠŸèƒ½å·²å¯ç”¨ï¼Œæ­£åœ¨ç›‘å¬ç¯å¢ƒå£°éŸ³...")

        # ä¸»å¾ªç¯
        try:
            while True:
                time.sleep(1)

        except KeyboardInterrupt:
            print("\næ­£åœ¨åœæ­¢ç³»ç»Ÿ...")

    except Exception as e:
        print(f"ç³»ç»Ÿå¯åŠ¨å¤±è´¥: {e}")
        traceback.print_exc()
        return

    finally:
        # æ¸…ç†èµ„æº
        try:
            if 'noise_detector' in locals() and hasattr(noise_detector, 'stop'):
                noise_detector.stop()
            if 'speech_engine' in locals():
                speech_engine.stop()
            if 'speech_service' in locals():
                speech_service.stop()
            if 'cam_manager' in locals():
                cam_manager.stop()
            print("ç³»ç»Ÿå·²å®‰å…¨åœæ­¢")
        except:
            pass

<<<<<<< HEAD
    # ä¸ºæ¯ä¸ªæ£€æµ‹å™¨åˆ›å»ºå•ç‹¬çš„çº¿ç¨‹
    #qr_detector.run()
    qr_thread = threading.Thread(target=qr_detector.run_detection, name="QR_Detector")
    face_thread = threading.Thread(target=face_detector.run_detection, name="Face_Detector")
    photo_thread = threading.Thread(target=photo_detector.run_detection, name="Photo_Detector")
    #hand_thread = threading.Thread(target=hand_estimator.run_estimation, name="Hand_Pose_Estimator")
    
    # å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    qr_thread.start()
    face_thread.start()
    photo_thread.start()
    #hand_thread.start()
    memory_manager.start()#å†…éƒ¨åˆ›é€ çº¿ç¨‹äº†
    voice_assistant.start()#å†…éƒ¨åˆ›é€ çº¿ç¨‹äº†
=======
>>>>>>> origin/hty

if __name__ == '__main__':
    main()
    time.sleep(10000)